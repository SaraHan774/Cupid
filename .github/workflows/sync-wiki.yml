name: Sync Documentation to Wiki

on:
  push:
    branches:
      - master
    paths:
      - 'src/main/kotlin/com/august/cupid/controller/**'
      - 'src/main/kotlin/com/august/cupid/dto/**'
      - 'src/main/kotlin/com/august/cupid/config/OpenApiConfig.kt'
      - 'docs/wiki/**'
      - '.github/workflows/sync-wiki.yml'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all documentation'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cupid_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate OpenAPI specification
        run: ./gradlew generateOpenApiDocs
        env:
          SPRING_PROFILES_ACTIVE: docs
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/cupid_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          SPRING_DATA_MONGODB_HOST: localhost
          SPRING_DATA_MONGODB_PORT: 27017

      - name: Validate OpenAPI spec
        run: |
          if [ ! -f build/openapi/openapi.json ]; then
            echo "OpenAPI spec not generated"
            exit 1
          fi
          echo "OpenAPI spec generated successfully"
          cat build/openapi/openapi.json | head -50

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate Wiki documentation
        run: |
          chmod +x scripts/generate-wiki.sh
          ./scripts/generate-wiki.sh

      - name: List generated files
        run: |
          echo "Generated wiki files:"
          find docs/wiki -name "*.md" -type f | sort

      - name: Checkout wiki repository
        id: checkout-wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check if wiki exists
        id: wiki-check
        run: |
          if [ -d "wiki/.git" ]; then
            echo "wiki_exists=true" >> $GITHUB_OUTPUT
            echo "Wiki repository exists"
          else
            echo "wiki_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Wiki repository not found. Please create the wiki first:"
            echo "::warning::1. Go to https://github.com/${{ github.repository }}/wiki"
            echo "::warning::2. Click 'Create the first page'"
            echo "::warning::3. Save any content to initialize the wiki"
            echo "::warning::4. Re-run this workflow"
          fi

      - name: Sync documentation to wiki
        if: steps.wiki-check.outputs.wiki_exists == 'true'
        run: |
          # Copy all generated markdown files to wiki
          cp -r docs/wiki/* wiki/

          # Navigate to wiki directory
          cd wiki

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected, committing..."
            git add -A
            git commit -m "docs: Auto-update API documentation

          Generated from commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}

          ðŸ¤– Generated with GitHub Actions"

            # Push changes
            git push origin master || git push origin HEAD:master
            echo "Wiki updated successfully"
          else
            echo "No changes to wiki"
          fi

      - name: Skip wiki sync (wiki not initialized)
        if: steps.wiki-check.outputs.wiki_exists != 'true'
        run: |
          echo "Skipping wiki sync - wiki repository needs to be initialized first"
          echo "Generated documentation is available in the artifacts"

      - name: Upload OpenAPI spec as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: build/openapi/openapi.json
          retention-days: 30

      - name: Upload generated wiki as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wiki-docs
          path: docs/wiki/
          retention-days: 30

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: generate-and-sync
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'âš ï¸ Wiki sync failed';
            const body = `
            The wiki documentation sync workflow failed.

            **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Commit:** ${context.sha}
            **Branch:** ${context.ref}

            Please check the workflow logs for details.
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['documentation', 'automated', 'bug']
              });
            }
