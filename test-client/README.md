# Cupid Chat Test Client

백엔드 API를 테스트하기 위한 간단한 웹 클라이언트입니다.

## 주요 기능

- ✅ 사용자 인증 (로그인/회원가입)
- ✅ 채널 목록 조회 및 생성
- ✅ 메시지 전송 및 수신
- ✅ WebSocket 실시간 메시지 교환
- ✅ Firebase Cloud Messaging (FCM) 푸시 알림 테스트
- ✅ 백엔드 API와 완전히 호환

## 실행 방법

### 1. 백엔드 서버 실행

```bash
cd /Users/gahee/IdeaProjects/Cupid
./gradlew bootRun
```

서버는 `http://localhost:8080`에서 실행됩니다.

### 2. 테스트 클라이언트 실행

```bash
cd test-client
python3 -m http.server 8000
```

브라우저에서 `http://localhost:8000`으로 접속하세요.

## 2명 사용자 테스트 시나리오

### Step 1: 첫 번째 사용자 등록

1. 브라우저에서 `http://localhost:8000` 접속
2. "회원가입" 탭 클릭
3. 다음 정보 입력:
   - 사용자명: `user1`
   - 비밀번호: `password123`
   - 닉네임: `User 1`
4. 회원가입 버튼 클릭

### Step 2: 두 번째 사용자 등록

1. **새 브라우저 창** 또는 **시크릿 모드**에서 `http://localhost:8000` 접속
2. "회원가입" 탭 클릭
3. 다음 정보 입력:
   - 사용자명: `user2`
   - 비밀번호: `password123`
   - 닉네임: `User 2`
4. 회원가입 버튼 클릭

### Step 3: 채널 생성

**User 1** 브라우저에서:
1. 좌측 사이드바의 **"+"** 버튼 클릭
2. 채널 생성 다이얼로그에서:
   - 채널명: `테스트 채널`
   - 채널 타입: `그룹 채팅`
   - 참여자 ID: (비워두거나, user2의 ID 입력)
3. "생성" 버튼 클릭

### Step 4: 메시지 교환

**User 1** 브라우저에서:
1. 좌측 사이드바에서 생성한 채널 클릭
2. 하단 입력창에 "안녕하세요!" 입력
3. 전송 버튼 클릭 또는 Enter 키

**User 2** 브라우저에서:
1. **새로고침** 또는 채널 목록 클릭하여 채널 보기
2. 좌측 사이드바에서 같은 채널 클릭
3. User 1의 메시지가 표시되는지 확인
4. "반갑습니다!" 입력 후 전송

### Step 5: 실시간 메시지 수신 확인

**User 1**에서 메시지를 보내면 **User 2**가 즉시 받아야 합니다 (WebSocket).

**User 2**에서 메시지를 보내면 **User 1**이 즉시 받아야 합니다.

## 주요 수정 사항 (2025-01-29)

### 1. 백엔드 API 호환성 개선
- 모든 API 응답 구조를 백엔드와 일치하도록 수정
- WebSocket 엔드포인트 `/ws`로 수정 (기존: `/ws/chat`)
- 로그인/회원가입 응답 처리 개선
- 채널 목록 및 메시지 목록 응답 처리 개선

### 2. 사용자 정보 캐싱
- 채널 멤버 정보를 캐시하여 메시지 발신자 이름 표시
- 성능 최적화 및 불필요한 API 호출 감소

### 3. WebSocket 메시지 전송 및 수신
- `/app/send` 엔드포인트로 메시지 전송
- `/user/{userId}/queue/messages`로 메시지 수신
- 실시간 브로드캐스트 완전 지원

### 4. HTTP 폴백
- WebSocket 연결이 없을 경우 HTTP API로 폴백
- 오프라인 환경에서도 작동

### 5. UI/UX 개선
- 채널 생성 다이얼로그 개선
- 메시지 시간 포맷 개선
- 호버 효과 추가
- 콘솔 로그로 디버깅 지원

## 문제 해결

### Rate Limiting 오류 (429)
- 백엔드에서 요청 제한이 있습니다
- 1분 정도 기다린 후 다시 시도하세요

### WebSocket 연결 실패
- 브라우저 개발자 도구 (F12) → Console 탭 확인
- Backend 서버가 실행 중인지 확인
- Network 탭에서 WebSocket 연결 상태 확인

### 메시지가 실시간으로 오지 않음
- WebSocket 연결 상태 확인 (Console 로그)
- 두 사용자가 모두 온라인 상태인지 확인
- 채널 ID가 정확한지 확인

## 디버깅 팁

### 1. 브라우저 개발자 도구 열기
- F12 키를 누르거나 우클릭 → 검사

### 2. 콘솔에서 확인할 로그들
```
WebSocket 연결됨: ...
메시지 구독 완료: /user/.../queue/messages
WebSocket으로 메시지 전송: ...
메시지 수신: ...
```

### 3. 네트워크 탭
- WS (WebSocket) 연결 상태 확인
- API 요청/응답 확인

## 코드 구조

### 주요 함수
- `login()` - 로그인
- `register()` - 회원가입
- `connectWebSocket()` - WebSocket 연결
- `sendMessage()` - 메시지 전송 (WebSocket 우선)
- `displayMessage()` - 메시지 표시
- `selectChannel()` - 채널 선택
- `loadChannels()` - 채널 목록 로드

### WebSocket 플로우
```
1. 로그인 → JWT 토큰 받음
2. WebSocket 연결 (토큰 포함)
3. /user/{userId}/queue/messages 구독
4. 메시지 전송: stompClient.send("/app/send", ...)
5. 다른 사용자에게 브로드캐스트
6. /user/{userId}/queue/messages로 수신
```

## 한글 주석
모든 코드에 한글 주석이 포함되어 있어 이해하기 쉽습니다.

## Firebase 푸시 알림 테스트

### 사전 준비

1. **Firebase 프로젝트 설정**
   - Firebase 콘솔에서 웹 앱을 생성하고 설정 값을 복사합니다
   - `test-client/firebase-config.js` 파일을 생성하고 Firebase 설정 값을 입력합니다
   - Cloud Messaging > 웹 구성에서 VAPID 키를 발급받아 설정합니다

2. **서비스 워커 등록**
   - 브라우저가 `firebase-messaging-sw.js`를 자동으로 등록합니다
   - HTTPS 또는 localhost에서만 동작합니다

### 테스트 절차

1. **로그인**
   - 먼저 로그인하여 인증 토큰을 받습니다

2. **알림 권한 요청**
   - "📡 API 테스트" 탭으로 이동
   - "Firebase 푸시 알림 테스트" 섹션에서 "브라우저 알림 권한 요청" 클릭
   - 브라우저 알림 권한 팝업에서 "허용" 선택

3. **FCM 토큰 등록**
   - "FCM 토큰 발급 및 서버 등록" 버튼 클릭
   - FCM 토큰이 발급되고 서버에 등록됩니다
   - 등록된 토큰 ID가 화면에 표시됩니다

4. **토큰 목록 조회**
   - "서버에 등록된 토큰 조회" 버튼 클릭
   - 현재 사용자의 모든 등록된 토큰 목록을 확인할 수 있습니다

5. **푸시 알림 수신 테스트**
   - 백엔드에서 해당 사용자에게 푸시 알림을 전송하면
   - 브라우저 알림 센터에 알림이 표시됩니다
   - 포그라운드에서는 `messaging.onMessage` 핸들러가 실행됩니다

6. **토큰 삭제**
   - "현재 브라우저 토큰 삭제" 버튼 클릭
   - 서버에서 토큰이 삭제되고 더 이상 알림을 받지 않습니다

### 주의사항

- **HTTPS 필수**: 프로덕션에서는 HTTPS가 필수이지만, localhost에서는 HTTP도 동작합니다
- **브라우저 호환성**: Chrome, Firefox, Edge 등 최신 브라우저에서만 지원됩니다
- **서비스 워커**: 백그라운드 알림 수신을 위해 서비스 워커가 필요합니다
- **VAPID 키**: 웹 푸시 알림을 받으려면 VAPID 키가 필수입니다

## 참고사항
- 최소한의 디자인으로 구현되어 있습니다
- 데모/테스트 목적이며 프로덕션 사용은 권장하지 않습니다
- E2E 암호화는 백엔드에서 처리되지만, 이 클라이언트는 일반 텍스트로 표시합니다

