<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Protocol E2E ì•”í˜¸í™” í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-info {
            color: #4EC9B0;
        }
        .log-success {
            color: #4EC9B0;
        }
        .log-error {
            color: #F48771;
        }
        .log-warn {
            color: #DCDCAA;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Signal Protocol E2E ì•”í˜¸í™” í†µí•© í…ŒìŠ¤íŠ¸</h1>
        
        <div class="config">
            <label>API URL: </label>
            <input type="text" id="apiUrl" value="http://localhost:8080/api/v1" placeholder="API URL">
            <button onclick="updateApiUrl()">ì„¤ì • ì—…ë°ì´íŠ¸</button>
        </div>

        <div class="controls">
            <button onclick="runCompleteFlow()">ì „ì²´ í”Œë¡œìš° ì‹¤í–‰</button>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>

        <div id="status"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        // API URL ì„¤ì •
        let API_URL = 'http://localhost:8080/api/v1';

        function updateApiUrl() {
            API_URL = document.getElementById('apiUrl').value;
            log('API URLì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤: ' + API_URL, 'info');
        }

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('status').innerHTML = '';
        }

        function setStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // API í˜¸ì¶œ ë˜í¼
        async function apiCall(fn, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fn();
                    
                    if (response.status === 429) {
                        const retryAfter = response.headers.get('Retry-After') || 60;
                        log(`Rate Limit ì´ˆê³¼. ${retryAfter}ì´ˆ í›„ ì¬ì‹œë„...`, 'warn');
                        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                        continue;
                    }
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || `HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    log(`ì¬ì‹œë„ ì¤‘... (${i + 1}/${retries})`, 'warn');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ì¸ì¦ í•¨ìˆ˜ë“¤
        async function login(username, password) {
            const response = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (!response.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            const data = await response.json();
            return data.token;
        }

        async function register(username, password, email) {
            const response = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, email })
            });
            if (!response.ok) throw new Error('ë“±ë¡ ì‹¤íŒ¨');
            return await response.json();
        }

        // í‚¤ ê´€ë¦¬
        async function generateKeys(token, password) {
            return await apiCall(() => 
                fetch(`${API_URL}/encryption/keys/generate?password=${encodeURIComponent(password)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            );
        }

        async function checkKeyStatus(token) {
            return await apiCall(() =>
                fetch(`${API_URL}/encryption/keys/status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            );
        }

        async function getPublicKeyBundle(token, userId) {
            return await apiCall(() =>
                fetch(`${API_URL}/encryption/keys/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            );
        }

        // ì„¸ì…˜ ê´€ë¦¬
        async function initializeSession(token, recipientId) {
            return await apiCall(() =>
                fetch(`${API_URL}/encryption/key-exchange/initiate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipientId: recipientId,
                        recipientDeviceId: 1
                    })
                })
            );
        }

        async function checkSessionStatus(token, peerId) {
            const result = await apiCall(() =>
                fetch(`${API_URL}/encryption/session/${peerId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            );
            return result.data.hasSession;
        }

        // ë©”ì‹œì§€ ì•”í˜¸í™”/ë³µí˜¸í™”
        async function encryptMessage(token, recipientId, plaintext) {
            return await apiCall(() =>
                fetch(`${API_URL}/encryption/encrypt`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipientId: recipientId,
                        plaintext: plaintext
                    })
                })
            );
        }

        async function decryptMessage(token, senderId, ciphertext, messageType = 1) {
            return await apiCall(() =>
                fetch(`${API_URL}/encryption/decrypt`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderId: senderId,
                        ciphertext: ciphertext,
                        messageType: messageType
                    })
                })
            );
        }

        // ë°±ì—… ê´€ë¦¬
        async function createBackup(token, backupPassword, expirationDays = 90) {
            return await apiCall(() =>
                fetch(`${API_URL}/keys/backup`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        backupPassword: backupPassword,
                        expirationDays: expirationDays,
                        metadata: JSON.stringify({
                            device_name: 'Browser Test',
                            app_version: '1.0.0'
                        })
                    })
                })
            );
        }

        async function getBackupList(token) {
            return await apiCall(() =>
                fetch(`${API_URL}/keys/backup`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            );
        }

        // ì „ì²´ í”Œë¡œìš°
        async function runCompleteFlow() {
            try {
                clearLog();
                setStatus('í”Œë¡œìš° ì‹¤í–‰ ì¤‘...', 'info');
                log('=== Signal Protocol E2E ì•”í˜¸í™” í†µí•© ì˜ˆì œ ì‹œì‘ ===', 'info');

                // 1. ì‚¬ìš©ì ë“±ë¡
                log('1. ì‚¬ìš©ì ë“±ë¡ ì¤‘...', 'info');
                const timestamp = Date.now();
                const alicePassword = `AlicePass${timestamp}!`;
                const bobPassword = `BobPass${timestamp}!`;
                
                const aliceUser = await register(`alice_${timestamp}`, alicePassword, `alice_${timestamp}@example.com`);
                const bobUser = await register(`bob_${timestamp}`, bobPassword, `bob_${timestamp}@example.com`);
                
                log(`âœ“ Alice ë“±ë¡ ì™„ë£Œ - ID: ${aliceUser.id}`, 'success');
                log(`âœ“ Bob ë“±ë¡ ì™„ë£Œ - ID: ${bobUser.id}`, 'success');

                // 2. ë¡œê·¸ì¸
                log('\n2. ë¡œê·¸ì¸ ì¤‘...', 'info');
                const aliceToken = await login(`alice_${timestamp}`, alicePassword);
                const bobToken = await login(`bob_${timestamp}`, bobPassword);
                log('âœ“ ë¡œê·¸ì¸ ì™„ë£Œ', 'success');

                // 3. í‚¤ ìƒì„±
                log('\n3. í‚¤ ìƒì„± ì¤‘...', 'info');
                await generateKeys(aliceToken, alicePassword);
                log('âœ“ Alice í‚¤ ìƒì„± ì™„ë£Œ', 'success');
                await generateKeys(bobToken, bobPassword);
                log('âœ“ Bob í‚¤ ìƒì„± ì™„ë£Œ', 'success');

                // 4. í‚¤ ìƒíƒœ í™•ì¸
                log('\n4. í‚¤ ìƒíƒœ í™•ì¸...', 'info');
                const aliceKeyStatus = await checkKeyStatus(aliceToken);
                const bobKeyStatus = await checkKeyStatus(bobToken);
                log(`âœ“ Alice í‚¤ ìƒíƒœ: ${aliceKeyStatus.data.hasIdentityKey ? 'í‚¤ ìˆìŒ' : 'í‚¤ ì—†ìŒ'}`, 'success');
                log(`âœ“ Bob í‚¤ ìƒíƒœ: ${bobKeyStatus.data.hasIdentityKey ? 'í‚¤ ìˆìŒ' : 'í‚¤ ì—†ìŒ'}`, 'success');

                // 5. ì„¸ì…˜ ì´ˆê¸°í™”
                log('\n5. ì„¸ì…˜ ì´ˆê¸°í™” ì¤‘...', 'info');
                await initializeSession(aliceToken, bobUser.id);
                log('âœ“ ì„¸ì…˜ ì´ˆê¸°í™” ì™„ë£Œ', 'success');

                // 6. ì„¸ì…˜ ìƒíƒœ í™•ì¸
                log('\n6. ì„¸ì…˜ ìƒíƒœ í™•ì¸...', 'info');
                const hasSession = await checkSessionStatus(aliceToken, bobUser.id);
                log(`âœ“ ì„¸ì…˜ ì¡´ì¬ ì—¬ë¶€: ${hasSession}`, 'success');

                // 7. ë©”ì‹œì§€ ì•”í˜¸í™” ë° ì „ì†¡
                log('\n7. ë©”ì‹œì§€ ì•”í˜¸í™” ë° ì „ì†¡ ì¤‘...', 'info');
                const message = 'Hello, Bob! This is a secret message from Alice.';
                const encrypted = await encryptMessage(aliceToken, bobUser.id, message);
                log(`âœ“ ë©”ì‹œì§€ ì•”í˜¸í™” ì™„ë£Œ`, 'success');
                log(`  ì•”í˜¸í™”ëœ ë©”ì‹œì§€ (ì¼ë¶€): ${encrypted.data.ciphertext.substring(0, 50)}...`, 'info');

                // 8. ë©”ì‹œì§€ ë³µí˜¸í™”
                log('\n8. ë©”ì‹œì§€ ë³µí˜¸í™” ì¤‘...', 'info');
                const decrypted = await decryptMessage(
                    bobToken,
                    aliceUser.id,
                    encrypted.data.ciphertext,
                    encrypted.data.messageType
                );
                log(`âœ“ ë©”ì‹œì§€ ë³µí˜¸í™” ì™„ë£Œ`, 'success');
                log(`  ì›ë³¸ ë©”ì‹œì§€: "${decrypted.data.plaintext}"`, 'info');
                log(`  ë©”ì‹œì§€ ì¼ì¹˜: ${message === decrypted.data.plaintext ? 'âœ“' : 'âœ—'}`, 
                     message === decrypted.data.plaintext ? 'success' : 'error');

                // 9. ë°±ì—… ìƒì„±
                log('\n9. ë°±ì—… ìƒì„± ì¤‘...', 'info');
                const backupPassword = `BackupPass${timestamp}!`;
                const backup = await createBackup(aliceToken, backupPassword, 90);
                log(`âœ“ ë°±ì—… ìƒì„± ì™„ë£Œ - ID: ${backup.data.backupId}`, 'success');

                // 10. ë°±ì—… ëª©ë¡ ì¡°íšŒ
                log('\n10. ë°±ì—… ëª©ë¡ ì¡°íšŒ...', 'info');
                const backupList = await getBackupList(aliceToken);
                log(`âœ“ ë°±ì—… ê°œìˆ˜: ${backupList.data.totalCount} (í™œì„±: ${backupList.data.activeCount})`, 'success');

                log('\n=== ëª¨ë“  ì‘ì—… ì™„ë£Œ! ===', 'success');
                setStatus('âœ“ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                log(`\nâœ— ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                setStatus(`âœ— ì˜¤ë¥˜: ${error.message}`, 'error');
                console.error('ì „ì²´ ì—ëŸ¬:', error);
            }
        }
    </script>
</body>
</html>

