<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Protocol E2E ì•”í˜¸í™” í”Œë¡œìš° ë°ëª¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .content {
            padding: 30px;
        }
        .config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .config label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .config input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.6;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
            border-left: 4px solid #4EC9B0;
            border-radius: 5px;
        }
        .step.success {
            border-left-color: #4EC9B0;
            background: #1e3a3a;
        }
        .step.error {
            border-left-color: #F48771;
            background: #3a1e1e;
        }
        .step.info {
            border-left-color: #4A9EFF;
            background: #1e1e3a;
        }
        .step-number {
            color: #4EC9B0;
            font-weight: bold;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-running {
            background: #4A9EFF;
            color: white;
        }
        .status-success {
            background: #4EC9B0;
            color: #000;
        }
        .status-error {
            background: #F48771;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Signal Protocol E2E ì•”í˜¸í™” í†µí•© í”Œë¡œìš°</h1>
            <p>ì‹¤ì‹œê°„ ì•”í˜¸í™” í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸</p>
        </div>
        <div class="content">
            <div class="config">
                <label>API Base URL</label>
                <input type="text" id="apiUrl" value="http://localhost:8080/api/v1" placeholder="API URL">
                <button class="btn" onclick="updateApiUrl()">ì„¤ì • ì—…ë°ì´íŠ¸</button>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="runFlow()" id="runBtn">ğŸš€ ì „ì²´ í”Œë¡œìš° ì‹¤í–‰</button>
                <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>

            <div id="log" class="log">
                <div class="step info">
                    <span class="step-number">â„¹ï¸</span> ì¤€ë¹„ ì™„ë£Œ. "ì „ì²´ í”Œë¡œìš° ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_URL = 'http://localhost:8080/api/v1';
        let isRunning = false;

        function updateApiUrl() {
            API_URL = document.getElementById('apiUrl').value;
            addLog('API URL ì—…ë°ì´íŠ¸: ' + API_URL, 'info');
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const step = document.createElement('div');
            step.className = `step ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            
            let icon = 'â„¹ï¸';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            
            step.innerHTML = `<span class="step-number">${icon}</span> <strong>[${timestamp}]</strong> ${message}`;
            log.appendChild(step);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
        }

        async function apiCall(fn, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fn();
                    if (response.status === 429) {
                        const retryAfter = parseInt(response.headers.get('Retry-After') || '60');
                        addLog(`Rate Limit ì´ˆê³¼. ${retryAfter}ì´ˆ í›„ ì¬ì‹œë„...`, 'info');
                        await new Promise(r => setTimeout(r, retryAfter * 1000));
                        continue;
                    }
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                        throw new Error(error.error || error.message || `HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    addLog(`ì¬ì‹œë„ ì¤‘... (${i + 1}/${retries})`, 'info');
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        async function register(username, password, email) {
            return await apiCall(() => fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, email })
            }));
        }

        async function login(username, password) {
            const result = await apiCall(() => fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }));
            return result.token;
        }

        async function generateKeys(token, password) {
            return await apiCall(() => fetch(
                `${API_URL}/encryption/keys/generate?password=${encodeURIComponent(password)}`,
                {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                }
            ));
        }

        async function checkKeyStatus(token) {
            return await apiCall(() => fetch(`${API_URL}/encryption/keys/status`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            }));
        }

        async function initializeSession(token, recipientId) {
            return await apiCall(() => fetch(`${API_URL}/encryption/key-exchange/initiate`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ recipientId, recipientDeviceId: 1 })
            }));
        }

        async function checkSessionStatus(token, peerId) {
            const result = await apiCall(() => fetch(`${API_URL}/encryption/session/${peerId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            }));
            return result.data.hasSession;
        }

        async function encryptMessage(token, recipientId, plaintext) {
            return await apiCall(() => fetch(`${API_URL}/encryption/encrypt`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ recipientId, plaintext })
            }));
        }

        async function decryptMessage(token, senderId, ciphertext, messageType = 1) {
            return await apiCall(() => fetch(`${API_URL}/encryption/decrypt`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ senderId, ciphertext, messageType })
            }));
        }

        async function createBackup(token, backupPassword, expirationDays = 90) {
            return await apiCall(() => fetch(`${API_URL}/keys/backup`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    backupPassword,
                    expirationDays,
                    metadata: JSON.stringify({ device_name: 'Browser Test', app_version: '1.0.0' })
                })
            }));
        }

        async function getBackupList(token) {
            return await apiCall(() => fetch(`${API_URL}/keys/backup`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            }));
        }

        async function runFlow() {
            if (isRunning) return;
            isRunning = true;
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = 'ì‹¤í–‰ ì¤‘...';

            try {
                clearLog();
                const timestamp = Date.now();
                addLog('=== Signal Protocol E2E ì•”í˜¸í™” í†µí•© í”Œë¡œìš° ì‹œì‘ ===', 'info');

                // Step 1: ì‚¬ìš©ì ë“±ë¡
                addLog('Step 1: ì‚¬ìš©ì ë“±ë¡ ì¤‘...', 'info');
                const alicePassword = `Alice${timestamp}!`;
                const bobPassword = `Bob${timestamp}!`;
                const aliceUser = await register(`alice_${timestamp}`, alicePassword, `alice_${timestamp}@test.com`);
                const bobUser = await register(`bob_${timestamp}`, bobPassword, `bob_${timestamp}@test.com`);
                addLog(`âœ“ Alice ë“±ë¡ ì™„ë£Œ (ID: ${aliceUser.id.substring(0, 8)}...)`, 'success');
                addLog(`âœ“ Bob ë“±ë¡ ì™„ë£Œ (ID: ${bobUser.id.substring(0, 8)}...)`, 'success');

                // Step 2: ë¡œê·¸ì¸
                addLog('Step 2: ë¡œê·¸ì¸ ì¤‘...', 'info');
                const aliceToken = await login(`alice_${timestamp}`, alicePassword);
                const bobToken = await login(`bob_${timestamp}`, bobPassword);
                addLog('âœ“ Alice ë¡œê·¸ì¸ ì™„ë£Œ', 'success');
                addLog('âœ“ Bob ë¡œê·¸ì¸ ì™„ë£Œ', 'success');

                // Step 3: í‚¤ ìƒì„±
                addLog('Step 3: Signal Protocol í‚¤ ìƒì„± ì¤‘...', 'info');
                await generateKeys(aliceToken, alicePassword);
                addLog('âœ“ Alice í‚¤ ìƒì„± ì™„ë£Œ', 'success');
                await generateKeys(bobToken, bobPassword);
                addLog('âœ“ Bob í‚¤ ìƒì„± ì™„ë£Œ', 'success');

                // Step 4: í‚¤ ìƒíƒœ í™•ì¸
                addLog('Step 4: í‚¤ ìƒíƒœ í™•ì¸...', 'info');
                const aliceStatus = await checkKeyStatus(aliceToken);
                const bobStatus = await checkKeyStatus(bobToken);
                addLog(`âœ“ Alice: ${aliceStatus.data.hasIdentityKey ? 'í‚¤ ìˆìŒ' : 'í‚¤ ì—†ìŒ'}`, 'success');
                addLog(`âœ“ Bob: ${bobStatus.data.hasIdentityKey ? 'í‚¤ ìˆìŒ' : 'í‚¤ ì—†ìŒ'}`, 'success');

                // Step 5: ì„¸ì…˜ ì´ˆê¸°í™”
                addLog('Step 5: ì„¸ì…˜ ì´ˆê¸°í™” ì¤‘...', 'info');
                await initializeSession(aliceToken, bobUser.id);
                addLog('âœ“ ì„¸ì…˜ ì´ˆê¸°í™” ì™„ë£Œ', 'success');

                // Step 6: ì„¸ì…˜ ìƒíƒœ í™•ì¸
                addLog('Step 6: ì„¸ì…˜ ìƒíƒœ í™•ì¸...', 'info');
                const hasSession = await checkSessionStatus(aliceToken, bobUser.id);
                addLog(`âœ“ ì„¸ì…˜ ì¡´ì¬: ${hasSession}`, 'success');

                // Step 7: ë©”ì‹œì§€ ì•”í˜¸í™”
                addLog('Step 7: ë©”ì‹œì§€ ì•”í˜¸í™” ì¤‘...', 'info');
                const message = 'Hello, Bob! This is a secret message.';
                const encrypted = await encryptMessage(aliceToken, bobUser.id, message);
                addLog(`âœ“ ì•”í˜¸í™” ì™„ë£Œ (ê¸¸ì´: ${encrypted.data.ciphertext.length} chars)`, 'success');

                // Step 8: ë©”ì‹œì§€ ë³µí˜¸í™”
                addLog('Step 8: ë©”ì‹œì§€ ë³µí˜¸í™” ì¤‘...', 'info');
                const decrypted = await decryptMessage(
                    bobToken, aliceUser.id, 
                    encrypted.data.ciphertext, 
                    encrypted.data.messageType
                );
                const match = message === decrypted.data.plaintext;
                addLog(`âœ“ ë³µí˜¸í™” ì™„ë£Œ: "${decrypted.data.plaintext}"`, 'success');
                addLog(`âœ“ ë©”ì‹œì§€ ì¼ì¹˜: ${match ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}`, match ? 'success' : 'error');

                // Step 9: ë°±ì—… ìƒì„±
                addLog('Step 9: í‚¤ ë°±ì—… ìƒì„± ì¤‘...', 'info');
                const backupPassword = `Backup${timestamp}!`;
                const backup = await createBackup(aliceToken, backupPassword, 90);
                addLog(`âœ“ ë°±ì—… ìƒì„± ì™„ë£Œ (ID: ${backup.data.backupId.substring(0, 8)}...)`, 'success');

                // Step 10: ë°±ì—… ëª©ë¡ ì¡°íšŒ
                addLog('Step 10: ë°±ì—… ëª©ë¡ ì¡°íšŒ...', 'info');
                const backupList = await getBackupList(aliceToken);
                addLog(`âœ“ ë°±ì—… ê°œìˆ˜: ${backupList.data.totalCount} (í™œì„±: ${backupList.data.activeCount})`, 'success');

                addLog('\n=== ğŸ‰ ëª¨ë“  ì‘ì—… ì™„ë£Œ! ===', 'success');
            } catch (error) {
                addLog(`\nâŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error('ì „ì²´ ì—ëŸ¬:', error);
            } finally {
                isRunning = false;
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ì „ì²´ í”Œë¡œìš° ì‹¤í–‰';
            }
        }
    </script>
</body>
</html>

