# 채팅 SDK 기능 명세서 (표 버전)

## 프로젝트 개요
- **목적**: 소개팅 앱을 위한 채팅 SDK 개발 (추후 다른 앱에도 확장 가능)
- **주요 사용자**: 매칭된 사용자 간 1:1 채팅 및 그룹 채팅
- **기술 스택**: 
  - Backend: Kotlin + Spring Boot + WebSocket
  - SDK: JavaScript/TypeScript (ReactNative)
  - Database: PostgreSQL (사용자/채널), MongoDB (메시지)
  - Cache: Redis (세션, Pub/Sub)

---

## 기능 명세 종합표

| 대분류 | 중분류 | 소분류 | 세부 기능 | Phase | Config | 결정사항/참고 |
|--------|--------|--------|-----------|-------|--------|---------------|
| **1. 핵심 기능** | **1.0 보안 및 암호화** | Signal Protocol 통합 | - | 🔴 P1 | - | Signal Protocol 사용 결정 |
| | | 키 관리 | 사용자 키 쌍 생성 및 관리 | 🔴 P1 | - | |
| | | | 키 교환 (X3DH) | 🔴 P1 | - | |
| | | | Double Ratchet 알고리즘 | 🔴 P1 | - | |
| | | | Forward Secrecy | 🔴 P1 | - | |
| | | | 안전성 검증 (Safety Number) | 🔴 P1 | - | |
| | | | 키 백업 및 복구 | 🔴 P1 | - | 선택사항 |
| | | 영향받는 기능 | 모든 메시지/파일 암호화 | 🔴 P1 | - | |
| | | | 검색: 클라이언트 측만 가능 | 🟢 P3 | - | |
| | | | 신고: 별도 처리 방안 필요 | 🔴 P1 | - | |
| | **1.1 사용자 인증/연결** | SDK 초기화 | API Key, 서버 URL 설정 | 🔴 P1 | ⚙️ | |
| | | 사용자 인증 | JWT 토큰 기반 | 🔴 P1 | - | |
| | | WebSocket | 연결/재연결 (자동) | 🔴 P1 | ⚙️ | reconnectAttempts 설정 가능 |
| | | | 연결 상태 모니터링 | 🔴 P1 | - | 연결됨/연결중/끊김 |
| | | 로그아웃 | 연결 해제 | 🔴 P1 | - | |
| | **1.2 채널 관리** | 1:1 채팅 | 채널 생성 | 🔴 P1 | - | |
| | | | 채널 목록 조회 (페이징) | 🔴 P1 | - | |
| | | | 채널 정보 조회 | 🔴 P1 | - | |
| | | | 채널 나가기 | 🔴 P1 | ⚙️ | directChannelDeleteMode |
| | | | 채널 삭제 | 🔴 P1 | ⚙️ | Mode 1: 개별 / Mode 2: 전체 삭제 |
| | | 그룹 채팅 | 그룹 채널 생성 | 🟡 P2 | ⚙️ | 기본 최대 3명, 커스터마이징 가능 |
| | | | 참여자 추가/제거 | 🟡 P2 | - | |
| | | | 채널 나가기 (개별) | 🟡 P2 | - | 항상 개별 나가기 |
| | **1.3 메시지 송수신** | 텍스트 | 전송/수신 | 🔴 P1 | - | E2E 암호화 적용 |
| | | 이미지 | 전송 (압축 옵션) | 🔴 P1 | - | 최대 20MB, E2E 암호화 |
| | | 파일 | 전송 (문서/기타) | 🟡 P2 | - | 최대 10MB, E2E 암호화 |
| | | 영상 | - | ❌ | - | 지원 안 함 |
| | | 메시지 관리 | 히스토리 조회 (페이징) | 🔴 P1 | - | |
| | | | 메시지 수정 | 🟡 P2 | ⚙️ | 기본 10분 이내, 커스터마이징 가능 |
| | | | 메시지 삭제 | 🟡 P2 | - | "삭제된 메시지입니다" 표시 |
| | | | 읽지 않은 메시지 카운트 | 🔴 P1 | - | |
| | | | 실시간 알림 | 🔴 P1 | - | |
| | **1.4 실시간 상태** | 읽음 표시 | Read Receipt | 🔴 P1 | - | |
| | | 타이핑 | 타이핑 인디케이터 | 🔴 P1 | - | |
| | | 온라인 상태 | 온라인/오프라인 | 🔴 P1 | - | |
| | | | 마지막 접속 시간 | 🔴 P1 | - | |
| **2. 소개팅 특화** | **2.1 매칭 기반 채팅** | 매칭 연동 | 매칭 ID 연동 | 🔴 P1 | - | 매칭된 사용자만 채팅 가능 |
| | | | 매칭 상태 확인 | 🔴 P1 | - | 활성/만료/취소 |
| | | 매칭 해제 처리 | Mode 1: 완전 삭제 | 🔴 P1 | ⚙️ | 기본값 |
| | | | Mode 2: 읽기 전용 | 🔴 P1 | ⚙️ | |
| | | | Mode 3: 일정 기간 후 삭제 | 🔴 P1 | ⚙️ | |
| | **2.2 첫 대화 지원** | 첫 메시지 | 전송 여부 확인 | 🟡 P2 | - | 선택사항 |
| | | 아이스브레이킹 | 메시지 템플릿 | 🟡 P2 | - | 선택사항 |
| | | 시간 제한 | 대화 시작 제한 시간 | 🟡 P2 | - | 예: 24시간 |
| | **2.3 안전 기능** | 차단 | 사용자 차단 | 🔴 P1 | - | 상호 메시지 불가 |
| | | | 차단 목록 관리 | 🔴 P1 | - | |
| | | 신고 | 메시지 신고 | 🔴 P1 | - | E2E 고려: 복호화된 내용 전달 |
| | | | 사용자 신고 | 🔴 P1 | - | |
| | | 컨텐츠 필터링 | 부적절한 컨텐츠 필터 | 🟡 P2 | - | 클라이언트 측 필터링 |
| | | 스팸 방지 | 메시지 전송 빈도 제한 | 🟢 P3 | - | |
| | **2.4 프라이버시** | 프로필 | 상대방 프로필 확인 | 🟢 P3 | - | |
| | | 사진 공유 | 동의 시스템 | 🟢 P3 | - | |
| | | 메시지 삭제 | 자동 삭제 옵션 | 🟢 P3 | ⚙️ | 일정 기간 후 |
| **3. 부가 기능** | **3.1 음성 통화** | 1:1 통화 | 통화 연결/종료 | 🟡 P2 | - | WebRTC |
| | | | 통화 중 상태 표시 | 🟡 P2 | - | |
| | | | 음성 품질 조절 | 🟡 P2 | - | |
| | | | 마이크 on/off | 🟡 P2 | - | |
| | | | 스피커/이어폰 전환 | 🟡 P2 | - | |
| | | | 통화 기록 | 🟡 P2 | - | 시간 기록 |
| | | 접근성 | TalkBack/VoiceOver 지원 | 🟡 P2 | - | 시각 장애 사용자 지원 |
| | | | 음성 명령 인터페이스 | 🟡 P2 | - | |
| | | 그룹 통화 | - | ❌ | - | 지원 안 함 |
| | **3.2 알림** | 푸시 알림 | FCM 연동 | 🔴 P1 | - | |
| | | 인앱 알림 | - | 🟡 P2 | - | |
| | | 알림 설정 | 채널별 on/off | 🟡 P2 | - | |
| | | 방해 금지 | - | 🟡 P2 | - | |
| | **3.3 미디어 관리** | 이미지 | 썸네일 생성 | 🟡 P2 | - | |
| | | | 미리보기 | 🟡 P2 | - | |
| | | | 로컬 캐싱 | 🟡 P2 | - | |
| | | 파일 | 다운로드 진행률 | 🟡 P2 | - | |
| | **3.4 검색** | 메시지 검색 | 채널 내 검색 | 🟢 P3 | - | 클라이언트 측만 (E2E 암호화) |
| | | 채널 검색 | 채널명, 참여자 | 🟢 P3 | - | |
| | **3.5 데이터 관리** | 로컬 캐싱 | 오프라인 지원 | 🟡 P2 | - | |
| | | 동기화 | - | 🟡 P2 | - | |
| | | 캐시 정리 | - | 🟡 P2 | - | |
| | | 백업/복원 | - | 🟡 P2 | - | |
| | | 자동 삭제 | 보관 기간 이후 | 🟡 P2 | ⚙️ | 1시간 단위, 기본값 null (무제한) |
| **4. 관리자 기능** | 모니터링 | 채팅방 모니터링 | 🟢 P3 | - | 선택사항 |
| | 신고 검토 | 신고된 메시지 검토 | 🟢 P3 | - | |
| | 사용자 관리 | 강제 차단 | 🟢 P3 | - | |
| | 통계 | 활성 채팅방 수, 메시지 수 | 🟢 P3 | - | |

**범례**:
- 🔴 P1 = Phase 1 (MVP)
- 🟡 P2 = Phase 2 (확장)
- 🟢 P3 = Phase 3 (고급)
- ❌ = 지원 안 함
- ⚙️ = Config 설정 가능

---

## Phase별 요약

| Phase | 기간 | 핵심 목표 | 주요 기능 |
|-------|------|-----------|----------|
| 🔴 **Phase 1** | 8~10주 | MVP (1:1 채팅 + E2E) | Signal Protocol, 1:1 채팅, 안전 기능, 푸시 알림 |
| 🟡 **Phase 2** | 6~8주 | 확장 (그룹 + 미디어 + 통화) | 그룹 채팅, 파일 전송, 음성 통화, 메시지 수정/삭제 |
| 🟢 **Phase 3** | 4~6주 | 고급 (검색 + 관리) | 검색, 관리자 도구, 스팸 방지 |
| **전체** | **18~24주** | **완성형 SDK** | **약 4.5~6개월** |

---

## Config 설정 항목 요약

| 설정 항목 | 타입 | 기본값 | 설명 |
|-----------|------|--------|------|
| `apiKey` | String | (필수) | API 키 |
| `serverUrl` | String | (필수) | 서버 URL |
| `messageEditTimeLimit` | Duration | 10분 | 메시지 수정 가능 시간 (1시간 단위) |
| `messageRetentionPeriod` | Duration? | null | 메시지 보관 기간 (null = 무제한) |
| `maxImageSize` | Long | 20MB | 이미지 최대 크기 |
| `maxFileSize` | Long | 10MB | 파일 최대 크기 |
| `maxGroupSize` | Int | 3 | 그룹 최대 인원 |
| `directChannelDeleteMode` | Enum | INDIVIDUAL | 1:1 채널 삭제 모드 |
| `matchReleaseMode` | Enum | DELETE | 매칭 해제 시 처리 모드 |
| `enableLogging` | Boolean | false | 로깅 활성화 |
| `reconnectAttempts` | Int | 5 | 재연결 시도 횟수 |

### Config 모드 옵션

**ChannelDeleteMode** (1:1 채널 삭제)
- `INDIVIDUAL`: 각자 개별 나가기 (기본값)
- `DELETE_ALL`: 한 명 나가면 전체 삭제

**MatchReleaseMode** (매칭 해제 처리)
- `DELETE`: 완전 삭제 (기본값)
- `READ_ONLY`: 읽기 전용 전환
- `AUTO_DELETE`: 일정 기간 후 삭제

---

## 기술적 결정사항

| 항목 | 결정 | 비고 |
|------|------|------|
| E2E 암호화 | ✅ Signal Protocol (Phase 1) | 개발 시간 +2~4주, 검색/신고 복잡도 증가 |
| 음성 통화 | ✅ 1:1 WebRTC (Phase 2) | 시각 장애 사용자 지원, 그룹 통화 ❌ |
| 영상 통화 | ❌ 지원 안 함 | - |
| 영상 전송 | ❌ 지원 안 함 | - |
| 메시지 보관 기간 | ⚙️ Config 설정 (1시간 단위) | 기본값: null (무제한) |
| 멀티 디바이스 | 🔵 Phase 4 이후 검토 | 키 동기화 필요 |

---

## SDK 사용 예시

```kotlin
// SDK 초기화
ChatSDK.initialize(
    config = ChatConfig(
        apiKey = "your-api-key",
        serverUrl = "wss://your-server.com",
        
        // 커스터마이징
        messageEditTimeLimit = 15.minutes,
        messageRetentionPeriod = 7.days,
        maxGroupSize = 5,
        directChannelDeleteMode = ChannelDeleteMode.DELETE_ALL,
        matchReleaseMode = MatchReleaseMode.READ_ONLY
    )
)

// 연결
ChatSDK.connect()

// 채널 생성
val channel = ChatSDK.createChannel(
    type = ChannelType.DIRECT,
    participants = listOf("user1", "user2"),
    matchId = "match123"
)

// 메시지 전송
ChatSDK.sendMessage(
    channelId = channel.id,
    message = Message(
        text = "안녕하세요!",
        type = MessageType.TEXT
    )
)

// 이벤트 수신
ChatSDK.on("message") { message ->
    println("New message: ${message.text}")
}
```

---

## 다음 단계

1. [ ] API 명세서 작성 (상세 엔드포인트 정의)
2. [ ] 데이터베이스 스키마 설계
3. [ ] 프로젝트 구조 설계 (백엔드 + SDK)
4. [ ] 개발 환경 설정
5. [ ] Phase 1 개발 시작
